  name: CI Omar

  on:
    push:
      branches: ["feat/ci-cd-omar"]
    pull_request:
      branches: ["main"]

  jobs:
    build-and-test:
      runs-on: ubuntu-latest
      env:
        SONAR_HOST_URL: https://sonarcloud.io

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Set up JDK 21
          uses: actions/setup-java@v4
          with:
            distribution: temurin
            java-version: 21
            cache: gradle

        - name: Grant execute permission for gradlew
          run: chmod +x gradlew

        - name: Run unit tests
          run: ./gradlew test --no-daemon

        - name: Run Checkstyle linter
          run: ./gradlew checkstyleMain checkstyleTest --no-daemon

        - name: Generate JaCoCo coverage report
          run: ./gradlew jacocoTestReport --no-daemon

        - name: Upload test results
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: omar-test-results
            path: build/test-results/test

        - name: Upload coverage report
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: omar-coverage-report
            path: build/reports/jacoco/test

        - name: SonarCloud Scan
          if: ${{ env.SONAR_TOKEN != '' && env.SONAR_PROJECT_KEY != '' && env.SONAR_ORGANIZATION != '' }}
          uses: SonarSource/sonarcloud-github-action@v2
          env:
            GITHUB_TOKEN: ${{ github.token }}
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            SONAR_USER_HOME: ${{ github.workspace }}/.sonar
          with:
            args: >
              -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }}
              -Dsonar.organization=${{ vars.SONAR_ORGANIZATION }}
              -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
              -Dsonar.sources=src/main/java
              -Dsonar.tests=src/test/java
              -Dsonar.java.binaries=build/classes/java/main
              -Dsonar.java.test.binaries=build/classes/java/test
              -Dsonar.junit.reportPaths=build/test-results/test
              -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml

        - name: Check SonarCloud Quality Gate
          if: ${{ env.SONAR_TOKEN != '' && env.SONAR_PROJECT_KEY != '' && env.SONAR_ORGANIZATION != '' }}
          uses: SonarSource/sonarqube-quality-gate-action@v1
          env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}